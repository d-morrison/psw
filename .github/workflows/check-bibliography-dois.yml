name: Check Bibliography DOIs

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  check-dois:
    runs-on: ubuntu-latest
    container:
      image: rocker/tidyverse:latest
    permissions:
      contents: read
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r-dependencies@HEAD
        with:
          extra-packages: |
            any::pkgdown
            any::rmarkdown
            any::bib2df
            any::httr
            any::jsonlite
            any::stringr

      - name: Find bibliography files
        id: find-bibs
        run: |
          # Find all .bib files in the repository
          BIB_FILES=$(find . -name "*.bib" -not -path "./.git/*" | tr '\n' ' ')
          echo "Found bibliography files: $BIB_FILES"
          echo "bib_files=$BIB_FILES" >> $GITHUB_OUTPUT

      - name: Check bibliography DOIs
        if: steps.find-bibs.outputs.bib_files != ''
        run: |
          Rscript .github/scripts/check-bibliography-dois.R ${{ steps.find-bibs.outputs.bib_files }}

      - name: Summary
        if: success()
        run: |
          echo "âœ“ All bibliography entries have valid DOIs"
